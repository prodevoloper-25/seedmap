<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soil Classification & Crop Recommendation</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        #camera {
            width: 100%;
            max-height: 300px;
        }
        #canvas {
            width: 100%;
            max-height: 300px;
        }
        #output {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2>Soil Classification & Crop Recommendation</h2>
        <div id="formSection">
            <!-- Button to Start Camera -->
            <button id="startCamera" class="btn btn-primary mt-3">Start Camera</button>

            <!-- Video element for camera feed -->
            <video id="camera" autoplay muted style="display:none;"></video>
            <canvas id="canvas" style="display:none;"></canvas>

            <!-- Button to Capture Image -->
            <button id="captureImage" class="btn btn-success mt-3" style="display:none;">Capture Image</button>
            <hr>

            <!-- File Upload Section -->
            <label for="fileInput" class="form-label">Or Upload an Image:</label>
            <input type="file" id="fileInput" accept="image/*" class="form-control mt-2">
            <hr>

            <!-- Latitude and Longitude Display -->
            <p><strong>Latitude:</strong> <span id="latitude"></span></p>
            <p><strong>Longitude:</strong> <span id="longitude"></span></p>
            <hr>

            <!-- Submit Button -->
            <button class="btn btn-primary" onclick="submitForm()">Submit</button>
        </div>

        <!-- Display Result -->
        <div id="output" class="mt-4"></div>
    </div>

    <script>
        const startCameraButton = document.getElementById("startCamera");
        const captureButton = document.getElementById("captureImage");
        const camera = document.getElementById("camera");
        const canvas = document.getElementById("canvas");
        const fileInput = document.getElementById("fileInput");
        const latitudeSpan = document.getElementById("latitude");
        const longitudeSpan = document.getElementById("longitude");

        let imageData = null;

        // Start the camera
        startCameraButton.addEventListener("click", async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment" },
                });
                camera.srcObject = stream;
                camera.style.display = "block";
                captureButton.style.display = "inline-block";
            } catch (error) {
                alert("Unable to access the camera.");
            }
        });

        // Capture the image from the camera
        captureButton.addEventListener("click", () => {
            const context = canvas.getContext("2d");
            canvas.width = camera.videoWidth;
            canvas.height = camera.videoHeight;
            context.drawImage(camera, 0, 0, canvas.width, canvas.height);
            imageData = canvas.toDataURL("image/jpeg");
            camera.style.display = "none";
            captureButton.style.display = "none";
            fileInput.disabled = true;
        });

        // Get the user's location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    latitudeSpan.textContent = position.coords.latitude;
                    longitudeSpan.textContent = position.coords.longitude;
                },
                (error) => {
                    alert("Unable to retrieve your location.");
                }
            );
        } else {
            alert("Geolocation is not supported by your browser.");
        }

        // Submit the form
        function submitForm() {
            const latitude = latitudeSpan.textContent;
            const longitude = longitudeSpan.textContent;
            const file = fileInput.files[0];

            if (!latitude || !longitude || (!file && !imageData)) {
                alert("Please provide all necessary information.");
                return;
            }

            const formData = new FormData();
            formData.append("latitude", latitude);
            formData.append("longitude", longitude);
            if (file) {
                formData.append("file", file);
            } else if (imageData) {
                const byteString = atob(imageData.split(',')[1]);
                const arrayBuffer = new ArrayBuffer(byteString.length);
                const uintArray = new Uint8Array(arrayBuffer);
                for (let i = 0; i < byteString.length; i++) {
                    uintArray[i] = byteString.charCodeAt(i);
                }
                const blob = new Blob([uintArray], { type: "image/jpeg" });
                formData.append("file", blob, "captured_image.jpg");
            }

            fetch("/upload", {
                method: "POST",
                body: formData,
            })
                .then((response) => response.json())
                .then((data) => {
                    const output = document.getElementById("output");
                    output.innerHTML = `
                        <h3>Results</h3>
                        <p><strong>Soil Type:</strong> ${data.soil_type} (Confidence: ${data.confidence.toFixed(2)}%)</p>
                        <p><strong>Temperature:</strong> ${data.temperature}Â°C</p>
                        <p><strong>Suitable Crops:</strong> ${data.suitable_crops.join(", ")}</p>
                    `;
                })
                .catch((error) => alert("Error processing your request."));
        }
    </script>
</body>
</html>

